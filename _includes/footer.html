<footer>
    <div class="container">
        <div class="row">
            <div class="col-12">
                
            </div>
        </div>
    </div>
</footer>
<script src='{{ site.baseurl }}/andrew/js/jquery-2.1.3.min.js'></script>
<script>
$(function() {
    var geocoder;
    var markerIcon = L.divIcon({
      className: 'marker',
      iconSize: [10, 10]
    });

    function showLocation(location) {
        markerGroup.setGeoJSON(data.results);
    }

    function renderResults(err, data) {
        // single address
        if (data.results.length === undefined) {
            var queryName = '';
            $.each(data.results.query, function (i, namePart) {
                if (i === data.results.query.length - 1) {
                    queryName = queryName + ', <span>' + namePart + '</span>';
                } else {
                    queryName = queryName + namePart + ' ';
                }
                console.log(queryName);
            });
            data.results.features[0].properties.query = queryName;
            data.results.features[0].properties.attribution = data.results.attribution;
            //showLocation(data.results);
        // batch
        } else {
            $.each(data.results, function(i, result) {
                // set 
                var queryName = '';
                $.each(result.query, function (i, namePart) {
                    if (i === result.query.length - 1) {
                        queryName = queryName + ', <span>' + namePart + '</span>';
                    } else {
                        queryName = queryName + namePart + ' ';
                    }
                });
                $.each(result.features, function(j, feature) {
                    feature.properties.query = queryName;
                    feature.properties.attribution = result.attribution;
                });
                
                //showLocation(result);
            });
            // show the count
            $('#count').append('Showing ' + (data.results.length - 1) + ' results');
        }

        markerGroup.setGeoJSON(data.results);

        // show data
        $('#downloads').css('display', 'block');
        $('#data').css('display', 'block');
        $('#count').css('display', 'block');
        $('.show-hide-data').css('display', 'block');
    }

    function setupGeoCoder() {
        // clear featureGroup
        markerGroup.clearLayers();
        // clear previous results
        $('#downloads').css('display', 'none');
        $('#data').css('display', 'none');
        $('#count').css('display', 'none');
        $('#data').html('');
        $('#count').html('');
        $('.show-hide-data').text('Hide Data');

        // if there is no ;
        // single address
        if ($('#address').val().indexOf(';') === -1) {
            var geocoder = L.mapbox.geocoder('mapbox.places');
            geocoder.query($('#address').val(), renderResults);
        // else batch
        } else {
            var geocoder = L.mapbox.geocoder('mapbox.places-permanent');
            geocoder.query($('#address').val() , renderResults);
        }
    }

    // set map size
    $('#map').height(($(document).height() - $('header').height() - 40) + 'px');

    // load base and settings
    L.mapbox.accessToken = 'pk.eyJ1IjoiY2ZwYiIsImEiOiJodmtiSk5zIn0.VkCynzmVYcLBxbyHzlvaQw';
    var map = L.mapbox.map('map', 'cfpb.k55b27gd', { zoomControl: false })
        .setView([39.8282, -98.5795], 4);
    new L.Control.Zoom({ position: 'bottomright' }).addTo(map);
    map.scrollWheelZoom.disable();

    // featureGroup for markers and add it to the map
    var markerGroup = L.mapbox.featureLayer().addTo(map);

    // when a layer is added
    markerGroup.on('layeradd', function(e) {
        var marker = e.layer,
        feature = marker.feature;

        if (feature.geometry.type === 'Point') {
            marker.setIcon(L.divIcon({
              className: 'marker',
              iconSize: [10, 10]
            }));
            console.log(feature.geometry.type);
            //console.log(marker);
            //console.log(feature);
            var queryName = '';
            /*$.each(marker.query, function (i, namePart) {
                if (i === marker.query.length - 1) {
                    queryName = queryName + ', <span>' + namePart + '</span>';
                } else {
                    queryName = queryName + namePart + ' ';
                }
            });*/
            $('#data').append('<div class="result group">'
                + '<p class="query">' + feature.properties.query + '</p>'
                + '<a class="lat-long" data-lat-long="[' + feature.center[1] + ', ' + feature.center[0] + ']" onclick="console.log(' + feature.center[1] + ');" href="#">'
                + feature.center[1] + ', ' + feature.center[0]
                + '</a>'
                + '<p class="placename">' + feature.place_name + '</p>'
                + '<p class="relevance">Score: ' + feature.relevance + '</p>'
                + '<p class="source">' + feature.properties.attribution + '</p>'
                + '</div>');
            map.fitBounds(markerGroup.getBounds());
        }
    });

    // on submit
    $('#geocode').submit(function(event) {
        setupGeoCoder();
        return false;
    });

    // on enter
    $('#address').keypress(function(e) {
        if (e.which == 13) {
            setupGeoCoder();
            return false;
        }
    });

    // file
    $('#batch').click(function() {
        var geocoder = L.mapbox.geocoder('mapbox.places-permanent');
        geocoder.query('cumberland, md; hagerstown, md; chambersburg, pa' , showBatch);
        return false;
    });

     $('.show-hide-data').click(function() {
        $('#data, #downloads').toggle( "slow", function() {
            if ($('#data').css('display') === 'none') {
                $('.show-hide-data').text('Show Data');
            } else {
                $('.show-hide-data').text('Hide Data');
            }
        });
    });

     // pan to the point from the panel
     // .on is used because the element being clicked is added to the DOM dynamically, by jQuery
     $('#data').on('click', '.lat-long', function() {
        console.log('made it');
        map.panTo($(this).data('lat-long'));
        return false;
     });
});
</script>

</body>
</html>